---
indicator:     submit
auto_fieldset: { legend: 'Prior Treatment' }
auto_constraint_class: %t
render_method: tt

##################
# PriorTreatment #
##################

elements:

  - type: Hidden
    name: id

  - type: Hidden
    name: patient_id

  - type: Select
    name: nominal_timepoint_id
    label: Time Before Entry
    empty_first: 1
    empty_first_label: -select-
    constraints:
      - AutoSet
    label_attributes:
      tooltipText: >-
        The time of the treatment relative to entry into the study. 
    model_config:
      resultset: ControlledVocab
      condition:
        category: PriorTimepoint
      label_column: value

  - type: Text
    name: date
    label: Treatment Date
    constraints:
      - type: Required
      - type: DateTime
        parser: &PARSER
          strptime: '%Y-%m-%d'
      - type: Length
        max:  10
        min:  1
      - type:    DBIC::Unique
        model:   DB::PriorTreatment
        myself:  object
        message: >-
          A treatment of this type for this patient on this date (with this date error) already exists.
        others:
          - days_uncertainty
          - type_id
          - patient_id
    label_attributes:
      tooltipText: >-
        The date of the treatment; click on the entry box for a pop-up calendar.

  - type: Text
    name: days_uncertainty
    label: Date uncertainty (days)
    constraints:
      - type: Required
      - type: Integer
      - type: Length
        max:  6
        min:  1
    label_attributes:
      tooltipText: >-
        The uncertainty in the date given, in days (e.g., if only
        the year is known then enter 365).

  - type: Select
    name: type_id
    label: Treatment Type
    constraints:
      - Required
      - AutoSet
    empty_first: 1
    empty_first_label: -select-
    label_attributes:
      tooltipText: >-
        The type of treatment administered.
    model_config:
      resultset: ControlledVocab
      condition:
        category: TreatmentType
      label_column: value

  - type: Text
    name: value
    label: Treatment value
    label_attributes:
      tooltipText: >-
        An optional free-text value describing the treatment.
    constraints:
      - type: ASCII
      - type: Length
        max:  255
        min:  1

  - type: Text
    name: duration
    label: Treatment duration
    label_attributes:
      tooltipText: >-
        The time the treatment lasted. 
    constraints:
      - type: Number
      - type: Length
        max:  10
        min:  0
      - type: DependOn
        others: duration_unit_id

  - type: Select
    name: duration_unit_id
    label: Duration units
    empty_first: 1
    empty_first_label: -select-
    constraints:
      - AutoSet
    label_attributes:
      tooltipText: >-
        Treatment duration units. 
    model_config:
      resultset: ControlledVocab
      condition:
        category: TimeUnit
      label_column: value

##########
# Submit #
##########

  - type: Submit
    name: submit
    value: Submit Form

constraints:
  - SingleValue

